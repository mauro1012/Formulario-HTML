<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bit√°cora Digital de Eventos Emergentes ‚Äì ARCH</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Cargamos las bibliotecas necesarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --border-radius: 6px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f7fa;
      padding: 0;
      margin: 0;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
      box-shadow: var(--box-shadow);
    }
    
    .header-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .subtitle {
      font-size: 16px;
      font-weight: 300;
      opacity: 0.9;
    }
    
    .form-card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
      margin-bottom: 30px;
    }
    
    .form-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    label {
      font-weight: 500;
      display: block;
      margin-bottom: 8px;
      color: var(--dark-color);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Roboto', sans-serif;
      font-size: 15px;
      transition: border 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .file-upload-container {
      margin-top: 15px;
    }
    
    .file-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .file-preview {
      border: 1px dashed #ddd;
      border-radius: var(--border-radius);
      padding: 10px;
      width: 150px;
      position: relative;
    }
    
    .file-preview img {
      max-width: 100%;
      max-height: 100px;
      display: block;
      margin-bottom: 5px;
    }
    
    .file-info {
      font-size: 12px;
      word-break: break-all;
    }
    
    .remove-file {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--accent-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
    }
    
    .btn {
      display: inline-block;
      background-color: var(--success-color);
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: var(--box-shadow);
      margin: 0 10px;
    }
    
    .btn:hover {
      background-color: #219653;
      transform: translateY(-2px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
    }
    
    .btn-secondary:hover {
      background-color: #2980b9;
    }
    
    .btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }
    
    .required-field::after {
      content: " *";
      color: var(--accent-color);
    }
    
    .section-title {
      font-size: 18px;
      color: var(--primary-color);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--light-color);
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 15px;
      padding-right: 30px;
    }
    
    .buttons-container {
      text-align: center;
      margin-top: 30px;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .form-card {
        padding: 20px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      .btn {
        display: block;
        width: 100%;
        margin: 10px 0;
      }
      
      .file-preview {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Bit√°cora Digital de Eventos Emergentes ‚Äì ARCH</h1>
      <p class="subtitle">Sistema integral de comunicaci√≥n para atender, procesar, controlar y monitorear eventos emergentes en el √°mbito hidrocarbur√≠fero nacional</p>
    </div>
  </header>

  <div class="container">
    <form id="bitacoraForm" class="form-card">
      <div class="form-section">
        <h2 class="section-title">Informaci√≥n del Reportante</h2>
        
        <div class="form-group">
          <label for="correo" class="required-field">1. Correo electr√≥nico</label>
          <input type="email" id="correo" name="correo" required placeholder="ejemplo@dominio.com">
        </div>
        
        <div class="form-group">
          <label for="direccion" class="required-field">2. Direcci√≥n que reporta</label>
          <select id="direccion" name="direccion" required>
            <option value="">Seleccione una direcci√≥n</option>
            <option value="DD AZUAY">DD AZUAY</option>
            <option value="DD CENTRO">DD CENTRO</option>
            <option value="DD CENTRO ORIENTE">DD CENTRO ORIENTE</option>
            <option value="DD ESMERALDAS">DD ESMERALDAS</option>
            <option value="DD EL ORO">DD EL ORO</option>
            <option value="DD GUAYAS">DD GUAYAS</option>
            <option value="DD LOJA">DD LOJA</option>
            <option value="DD MANAB√ç">DD MANAB√ç</option>
            <option value="DD NORTE">DD NORTE</option>
            <option value="DD PEN√çNSULA">DD PEN√çNSULA</option>
            <option value="DD SUCUMB√çOS">DD SUCUMB√çOS</option>
            <option value="DD SANTO DOMINGO">DD SANTO DOMINGO</option>
            <option value="MATRIZ">MATRIZ</option>
          </select>
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title">Detalles del Evento</h2>
        
        <div class="form-group">
          <label for="fecha" class="required-field">3. Fecha del evento</label>
          <input type="date" id="fecha" name="fecha" required>
        </div>
        
        <div class="form-group">
          <label for="hora" class="required-field">4. Hora del evento</label>
          <input type="time" id="hora" name="hora" required>
        </div>
        
        <div class="form-group">
          <label for="lugar" class="required-field">5. Lugar exacto del evento</label>
          <input type="text" id="lugar" name="lugar" required placeholder="Ej: Km 12 V√≠a a la Costa, Refiner√≠a Esmeraldas">
        </div>
        
        <div class="form-group">
          <label for="tipo-evento" class="required-field">6. Tipo de Evento</label>
          <select id="tipo-evento" name="tipo-evento" required>
            <option value="">Seleccione un tipo de evento</option>
            <option value="Derrame de hidrocarburos">Derrame de hidrocarburos</option>
            <option value="Protesta externa">Protesta externa</option>
            <option value="Falla en sistema cr√≠tico">Falla en sistema cr√≠tico</option>
            <option value="Accidente laboral">Accidente laboral</option>
            <option value="Interrupci√≥n operativa">Interrupci√≥n operativa</option>
            <option value="Otros">Otros (¬°especificar en Otros!)</option>
          </select>
        </div>
        
        <div class="form-group" id="otros-group" style="display: none;">
          <label for="otros">7. Especificar Otros</label>
          <input type="text" id="otros" name="otros" placeholder="Describa el tipo de evento si seleccion√≥ 'Otros'">
        </div>
        
        <div class="form-group">
          <label for="fase" class="required-field">8. Fase Hidrocarbur√≠fera donde sucede el evento</label>
          <select id="fase" name="fase" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="Exploraci√≥n y Explotaci√≥n">Exploraci√≥n y Explotaci√≥n</option>
            <option value="Refinaci√≥n e Industrializaci√≥n">Refinaci√≥n e Industrializaci√≥n</option>
            <option value="Transporte y Almacenamiento">Transporte y Almacenamiento</option>
            <option value="Comercializaci√≥n">Comercializaci√≥n</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="nivel" class="required-field">9. Clasificaci√≥n del nivel de emergencia</label>
          <select id="nivel" name="nivel" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="Nivel 1 (Local)">Nivel 1 (Local)</option>
            <option value="Nivel 2 (Nacional)">Nivel 2 (Nacional)</option>
            <option value="Nivel 3 (Estrat√©gico)">Nivel 3 (Estrat√©gico)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="fuente" class="required-field">10. Fuente de la Noticia</label>
          <input type="text" id="fuente" name="fuente" required placeholder="Ej: Reporte de campo, Llamada telef√≥nica, Monitoreo">
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title">Descripci√≥n del Evento</h2>
        
        <div class="form-group">
          <label for="detalle" class="required-field">11. Breve detalle del evento</label>
          <textarea id="detalle" name="detalle" required placeholder="Describa con precisi√≥n lo ocurrido"></textarea>
        </div>
        
        <div class="form-group">
          <label for="medidas" class="required-field">12. Medidas adoptadas</label>
          <textarea id="medidas" name="medidas" required placeholder="Describa las medidas tomadas para controlar la situaci√≥n"></textarea>
        </div>
        
        <div class="form-group">
          <label for="riesgos" class="required-field">13. Riesgos asociados</label>
          <textarea id="riesgos" name="riesgos" required placeholder="Enumere los riesgos potenciales identificados"></textarea>
        </div>
        
        <div class="form-group">
          <label for="afectacion" class="required-field">14. Afectaci√≥n estimada</label>
          <textarea id="afectacion" name="afectacion" required placeholder="Describa el impacto estimado del evento"></textarea>
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title">Seguimiento y Contactos</h2>
        
        <div class="form-group">
          <label for="acciones" class="required-field">15. Acciones ejecutadas hasta el momento</label>
          <textarea id="acciones" name="acciones" required placeholder="Describa las acciones realizadas para atender el evento"></textarea>
        </div>
        
        <div class="form-group">
          <label for="responsable" class="required-field">16. Responsable en sitio</label>
          <input type="text" id="responsable" name="responsable" required placeholder="Nombre completo del responsable">
        </div>
        
        <div class="form-group">
          <label for="telefono" class="required-field">17. Tel√©fono de contacto</label>
          <input type="tel" id="telefono" name="telefono" required placeholder="Ej: 0991234567">
        </div>
        
        <div class="form-group">
          <label for="coordinador" class="required-field">18. Coordinador responsable</label>
          <input type="text" id="coordinador" name="coordinador" required placeholder="Nombre completo del coordinador">
        </div>
        
        <div class="form-group">
          <label for="observaciones" class="required-field">19. Observaciones adicionales</label>
          <textarea id="observaciones" name="observaciones" required placeholder="Agregue cualquier informaci√≥n adicional relevante"></textarea>
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title">Evidencia Digital</h2>
        
        <div class="form-group">
          <label for="archivos">20. Cargar evidencias (m√∫ltiples archivos)</label>
          <div class="file-upload-container">
            <input type="file" id="archivos" name="archivos" accept=".jpg,.jpeg,.png" multiple>
            <small>Formatos aceptados: im√°genes. Tama√±o m√°ximo total: 10 MB.</small>
          </div>
          <div class="file-preview-container" id="filePreviews"></div>
        </div>
      </div>

      <div class="buttons-container">
        <button type="button" class="btn" id="generarPdfBtn">
          <span id="pdfBtnText">Generar PDF</span>
        </button>
        <button type="button" class="btn btn-secondary" id="enviarWhatsappBtn">
          <span id="whatsappBtnText">Enviar por WhatsApp</span>
        </button>
      </div>
    </form>
  </div>

  <script>
    // Esperamos a que todo est√© cargado
    document.addEventListener('DOMContentLoaded', function() {
      // Verificamos que las bibliotecas est√©n disponibles
      if (typeof window.jspdf !== 'undefined') {
        // jsPDF est√° disponible como window.jspdf
        window.jsPDF = window.jspdf.jsPDF;
        
        // Inicializamos la aplicaci√≥n
        inicializarAplicacion();
      } else {
        mostrarErrorBibliotecas();
      }
    });

    function inicializarAplicacion() {
      try {
        // Configurar fecha actual como valor por defecto
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').value = today;
        
        // Manejar cambio en tipo de evento
        document.getElementById('tipo-evento').addEventListener('change', function() {
          const otrosGroup = document.getElementById('otros-group');
          otrosGroup.style.display = this.value === 'Otros' ? 'block' : 'none';
          if (this.value !== 'Otros') document.getElementById('otros').value = '';
        });
        
        // Asignar eventos a los botones
        document.getElementById('generarPdfBtn').addEventListener('click', generarPDF);
        document.getElementById('enviarWhatsappBtn').addEventListener('click', enviarPorWhatsApp);
        
        // Configurar manejo de archivos
        setupFileHandling();
        
      } catch (error) {
        console.error('Error de inicializaci√≥n:', error);
        alert('Error al iniciar la aplicaci√≥n: ' + error.message);
      }
    }

    function mostrarErrorBibliotecas() {
      const errorMsg = `Error: No se pudieron cargar las bibliotecas necesarias.\n\nAseg√∫rese de que:\n1. Tiene conexi√≥n a internet\n2. No hay extensiones bloqueando los scripts\n3. Recargue la p√°gina\n\nSi el problema persiste, contacte al soporte t√©cnico.`;
      
      alert(errorMsg);
      console.error('Bibliotecas no cargadas:', {
        jsPDF: typeof window.jspdf,
        FileSaver: typeof saveAs
      });
      
      // Deshabilitar botones
      document.getElementById('generarPdfBtn').disabled = true;
      document.getElementById('enviarWhatsappBtn').disabled = true;
    }

    // Configurar manejo de archivos
    function setupFileHandling() {
      const fileInput = document.getElementById('archivos');
      let archivosSubidos = [];
      
      fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        const filePreviews = document.getElementById('filePreviews');
        filePreviews.innerHTML = '';
        
        // Validar tama√±o total
        const totalSize = files.reduce((total, file) => total + file.size, 0);
        if (totalSize > 10 * 1024 * 1024) {
          alert('El tama√±o total de los archivos supera los 10 MB');
          e.target.value = '';
          return;
        }
        
        archivosSubidos = files;
        
        files.forEach((file, index) => {
          const preview = document.createElement('div');
          preview.className = 'file-preview';
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'remove-file';
          removeBtn.innerHTML = '√ó';
          removeBtn.onclick = () => eliminarArchivo(index);
          
          const fileInfo = document.createElement('div');
          fileInfo.className = 'file-info';
          fileInfo.innerHTML = `
            <strong>${file.name}</strong><br>
            ${(file.size / 1024 / 1024).toFixed(2)} MB
          `;
          
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              preview.insertBefore(img, fileInfo);
            };
            reader.readAsDataURL(file);
          } else {
            const icon = document.createElement('div');
            icon.innerHTML = 'üìÑ';
            icon.style.fontSize = '40px';
            icon.style.textAlign = 'center';
            preview.insertBefore(icon, fileInfo);
          }
          
          preview.appendChild(removeBtn);
          preview.appendChild(fileInfo);
          filePreviews.appendChild(preview);
        });
      });

      function eliminarArchivo(index) {
        archivosSubidos.splice(index, 1);
        actualizarVistaPrevia();
      }

      function actualizarVistaPrevia() {
        const dt = new DataTransfer();
        archivosSubidos.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        
        const event = new Event('change');
        fileInput.dispatchEvent(event);
      }
    }

    // Validar formulario mejorado
    function validarFormulario() {
      const form = document.getElementById('bitacoraForm');
      const requiredFields = form.querySelectorAll('[required]');
      let isValid = true;
      
      // Resetear estilos de error
      requiredFields.forEach(field => {
        field.style.borderColor = '#ddd';
      });
      
      // Validar campos requeridos
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          field.style.borderColor = '#e74c3c';
          isValid = false;
          // Desplazarse al primer campo con error
          if (isValid === false) {
            field.focus();
          }
        }
      });
      
      // Validaci√≥n especial para campo "Otros"
      const tipoEvento = document.getElementById('tipo-evento').value;
      const otros = document.getElementById('otros').value;
      
      if (tipoEvento === 'Otros' && !otros.trim()) {
        document.getElementById('otros').style.borderColor = '#e74c3c';
        isValid = false;
        document.getElementById('otros').focus();
      }
      
      // Validar formato de email
      const email = document.getElementById('correo').value;
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.getElementById('correo').style.borderColor = '#e74c3c';
        isValid = false;
        document.getElementById('correo').focus();
      }
      
      if (!isValid) {
        alert('Por favor complete todos los campos obligatorios marcados con *.');
        return false;
      }
      
      return true;
    }

    // Mostrar carga en bot√≥n
    function showButtonLoading(buttonId, show) {
      const button = document.getElementById(buttonId);
      const textElement = button.querySelector('span');
      
      if (show) {
        button.disabled = true;
        textElement.innerHTML = `<span class="loading"></span>Procesando...`;
      } else {
        button.disabled = false;
        if (buttonId === 'generarPdfBtn') {
          textElement.textContent = 'Generar PDF';
        } else {
          textElement.textContent = 'Enviar por WhatsApp';
        }
      }
    }

    // Funci√≥n para leer archivo como DataURL
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        if (!file) {
          reject(new Error('No se proporcion√≥ archivo'));
          return;
        }
        
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('Error al leer el archivo'));
        reader.onabort = () => reject(new Error('Lectura del archivo abortada'));
        reader.readAsDataURL(file);
      });
    }

    // Subir PDF a File.io
    async function uploadToFileIO(blob, fileName) {
      try {
        const formData = new FormData();
        formData.append('file', blob, fileName);
        const response = await fetch('https://file.io', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        if (!result.success) {
          throw new Error('Error al subir el archivo a File.io');
        }
        return result.link;
      } catch (error) {
        console.error('Error al subir a File.io:', error);
        throw error;
      }
    }

    // Generar PDF
    async function generarPDF() {
      try {
        showButtonLoading('generarPdfBtn', true);
        
        if (!validarFormulario()) {
          showButtonLoading('generarPdfBtn', false);
          return null;
        }
        
        // Verificar que jsPDF est√© disponible
        if (typeof jsPDF === 'undefined') {
          throw new Error('La biblioteca para generar PDF no est√° disponible');
        }
        
        const doc = new jsPDF();
        
        // Configuraci√≥n
        doc.setFont('helvetica');
        doc.setFontSize(12);
        
        // Encabezado
        doc.setFontSize(16);
        doc.setTextColor(44, 62, 80);
        doc.text('Bit√°cora Digital de Eventos Emergentes ‚Äì ARCH', 105, 20, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text('Sistema integral de comunicaci√≥n para eventos emergentes', 105, 27, { align: 'center' });
        
        // L√≠nea separadora
        doc.setDrawColor(44, 62, 80);
        doc.setLineWidth(0.5);
        doc.line(20, 32, 190, 32);
        
        // Obtener datos del formulario
        const formData = getFormData();
        
        // Tabla de datos
        const data = [
          ['Campo', 'Valor'],
          ['1. Correo electr√≥nico', formData.correo],
          ['2. Direcci√≥n que reporta', formData.direccion],
          ['3. Fecha del evento', formData.fecha],
          ['4. Hora del evento', formData.hora],
          ['5. Lugar exacto del evento', formData.lugar],
          ['6. Tipo de Evento', formData.tipoEvento],
          ['8. Fase Hidrocarbur√≠fera', formData.fase],
          ['9. Nivel de emergencia', formData.nivel],
          ['10. Fuente de la Noticia', formData.fuente],
          ['16. Responsable en sitio', formData.responsable],
          ['17. Tel√©fono de contacto', formData.telefono],
          ['18. Coordinador responsable', formData.coordinador]
        ];
        
        // Crear tabla con autotable
        doc.autoTable({
          startY: 45,
          head: [data[0]],
          body: data.slice(1),
          theme: 'grid',
          headStyles: {
            fillColor: [44, 62, 80],
            textColor: [255, 255, 255],
            fontStyle: 'bold'
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240]
          },
          styles: {
            cellPadding: 5,
            fontSize: 10
          }
        });
        
        // Descripciones
        let yPos = doc.lastAutoTable.finalY + 15;
        
        const descripciones = [
          { titulo: '11. Breve detalle del evento', texto: formData.detalle },
          { titulo: '12. Medidas adoptadas', texto: formData.medidas },
          { titulo: '13. Riesgos asociados', texto: formData.riesgos },
          { titulo: '14. Afectaci√≥n estimada', texto: formData.afectacion },
          { titulo: '15. Acciones ejecutadas', texto: formData.acciones },
          { titulo: '19. Observaciones adicionales', texto: formData.observaciones }
        ];
        
        // Agregar descripciones al PDF
        for (const item of descripciones) {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFontSize(11);
          doc.setTextColor(44, 62, 80);
          doc.setFont('helvetica', 'bold');
          doc.text(item.titulo, 20, yPos);
          yPos += 7;
          
          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'normal');
          const splitText = doc.splitTextToSize(item.texto, 170);
          doc.text(splitText, 20, yPos);
          yPos += (splitText.length * 7) + 10;
        }
        
        // Agregar evidencias al PDF si existen
        const fileInput = document.getElementById('archivos');
        if (fileInput.files.length > 0) {
          await addAttachmentsToPDF(doc, fileInput.files);
        }
        
        // Pie de p√°gina
        const fechaReporte = new Date().toLocaleString();
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Reporte generado el: ${fechaReporte} - Bit√°cora Digital ARCH`, 105, 285, { align: 'center' });
        
        // Guardar PDF
        const pdfBlob = doc.output('blob');
        const fileName = `Bitacora_ARCH_${formData.fecha}_${formData.responsable.replace(/ /g, '_')}.pdf`;
        
        // Usar FileSaver.js si est√° disponible, sino m√©todo alternativo
        if (typeof saveAs !== 'undefined') {
          saveAs(pdfBlob, fileName);
        } else {
          const pdfUrl = URL.createObjectURL(pdfBlob);
          const a = document.createElement('a');
          a.href = pdfUrl;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(pdfUrl);
          }, 100);
        }
        
        showButtonLoading('generarPdfBtn', false);
        return pdfBlob;
        
      } catch (error) {
        console.error('Error al generar PDF:', error);
        alert('Error al generar el PDF: ' + error.message);
        showButtonLoading('generarPdfBtn', false);
        return null;
      }
    }

    // Obtener datos del formulario
    function getFormData() {
      return {
        correo: document.getElementById('correo').value,
        direccion: document.getElementById('direccion').value,
        fecha: document.getElementById('fecha').value,
        hora: document.getElementById('hora').value,
        lugar: document.getElementById('lugar').value,
        tipoEvento: document.getElementById('tipo-evento').value + 
                   (document.getElementById('tipo-evento').value === 'Otros' ? 
                    ' (' + document.getElementById('otros').value + ')' : ''),
        fase: document.getElementById('fase').value,
        nivel: document.getElementById('nivel').value,
        fuente: document.getElementById('fuente').value,
        detalle: document.getElementById('detalle').value,
        medidas: document.getElementById('medidas').value,
        riesgos: document.getElementById('riesgos').value,
        afectacion: document.getElementById('afectacion').value,
        acciones: document.getElementById('acciones').value,
        responsable: document.getElementById('responsable').value,
        telefono: document.getElementById('telefono').value,
        coordinador: document.getElementById('coordinador').value,
        observaciones: document.getElementById('observaciones').value
      };
    }

    // Agregar archivos adjuntos al PDF
    async function addAttachmentsToPDF(doc, files) {
      try {
        doc.addPage();
        doc.setFontSize(14);
        doc.setTextColor(44, 62, 80);
        doc.text('Evidencias Adjuntas', 20, 20);
        
        let yPos = 30;
        for (const file of files) {
          if (file.type.startsWith('image/')) {
            try {
              const imageData = await readFileAsDataURL(file);
              const img = new Image();
              img.src = imageData;
              
              await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
              });
              
              const ratio = img.width / img.height;
              const maxWidth = 170;
              const height = maxWidth / ratio;
              
              if (yPos + height > 260) {
                doc.addPage();
                yPos = 20;
              }
              
              doc.addImage(imageData, 'JPEG', 20, yPos, maxWidth, height);
              doc.text(`Imagen: ${file.name}`, 20, yPos + height + 5);
              yPos += height + 15;
            } catch (error) {
              console.error('Error al procesar imagen:', file.name, error);
              if (yPos > 260) {
                doc.addPage();
                yPos = 20;
              }
              doc.text(`Error al cargar imagen: ${file.name}`, 20, yPos);
              yPos += 10;
            }
          } else {
            if (yPos > 260) {
              doc.addPage();
              yPos = 20;
            }
            doc.text(`Documento: ${file.name} (${file.type})`, 20, yPos);
            yPos += 10;
          }
        }
      } catch (error) {
        console.error('Error al agregar adjuntos:', error);
        doc.addPage();
        doc.text('Error al procesar algunos archivos adjuntos', 20, 20);
      }
    }

    // Enviar por WhatsApp
    async function enviarPorWhatsApp() {
      try {
        showButtonLoading('enviarWhatsappBtn', true);
        
        // Generar PDF primero
        const pdfBlob = await generarPDF();
        if (!pdfBlob) {
          showButtonLoading('enviarWhatsappBtn', false);
          return;
        }
        
        // Crear nombre del archivo
        const formData = getFormData();
        const fileName = `Bitacora_ARCH_${formData.fecha}_${formData.responsable.replace(/ /g, '_')}.pdf`;

        // Subir PDF a File.io
        const downloadLink = await uploadToFileIO(pdfBlob, fileName);

        // Crear mensaje para WhatsApp con el enlace
        const mensaje = `*NUEVO REPORTE ARCH*\n\n` +
                       `Fecha: ${formData.fecha}\n` +
                       `Hora: ${formData.hora}\n` +
                       `Lugar: ${formData.lugar}\n` +
                       `Responsable: ${formData.responsable}\n` +
                       `Contacto: ${formData.telefono}\n` +
                       `Tipo: ${formData.tipoEvento}\n` +
                       `Nivel: ${formData.nivel}\n\n` +
                       `Detalle: ${formData.detalle.substring(0, 100)}${formData.detalle.length > 100 ? '...' : ''}\n\n` +
                       `Enlace al reporte completo: ${downloadLink}\n` +
                       `_El PDF tambi√©n se ha descargado autom√°ticamente_`;
        
        // Enviar por WhatsApp
        const phoneNumber = ''; // Puedes agregar un n√∫mero predeterminado si lo deseas
        const encodedMessage = encodeURIComponent(mensaje);
        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
        
        // Intentar abrir WhatsApp
        const newWindow = window.open(whatsappUrl, '_blank');
        
        // Si no se abri√≥ (puede ser bloqueado por el navegador)
        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
          // Copiar mensaje al portapapeles como respaldo
          try {
            await navigator.clipboard.writeText(mensaje);
            if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
              alert('No se pudo abrir WhatsApp autom√°ticamente. El mensaje con el enlace se ha copiado al portapapeles. Por favor:\n1. Abra WhatsApp manualmente\n2. Pegue el mensaje (mantenga presionado y seleccione Pegar)');
            } else {
              alert('No se pudo abrir WhatsApp autom√°ticamente. El mensaje con el enlace se ha copiado al portapapeles. Por favor:\n1. Abra WhatsApp Web/Desktop\n2. Pegue el mensaje (Ctrl+V)');
            }
          } catch (err) {
            console.error('Error al copiar al portapapeles:', err);
            alert('No se pudo abrir WhatsApp autom√°ticamente ni copiar el mensaje. Por favor:\n1. Abra WhatsApp manualmente\n2. Escriba el siguiente mensaje:\n\n' + mensaje);
          }
        }
        
        showButtonLoading('enviarWhatsappBtn', false);
        
      } catch (error) {
        console.error('Error al enviar por WhatsApp:', error);
        alert('Error al preparar el env√≠o por WhatsApp: ' + error.message);
        showButtonLoading('enviarWhatsappBtn', false);
      }
    }
  </script>
</body>
</html>
